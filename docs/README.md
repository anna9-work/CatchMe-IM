# 多倉庫進銷存管理系統

## 系統概述

本系統是一套完整的多倉庫進銷存管理解決方案，專為需要管理多個分店庫存的企業設計。系統整合了 Web App 管理介面、LINE Bot 出庫功能，以及 Google Sheets 每日報表自動同步功能，提供即時、準確的庫存管理能力。

### 核心功能

| 功能模組 | 說明 |
|---------|------|
| 商品管理 | SKU 唯一識別、箱入數設定、單價管理、安全庫存設定 |
| 分店管理 | 多分店支援、LINE 群組綁定、分店代碼設定 |
| 入庫作業 | 箱/散分開記錄、單位成本輸入、加權平均成本自動計算 |
| 異動單系統 | 補出庫、補入庫、箱散轉換、審核工作流 |
| 月盤點 | 系統庫存對比、差異計算、庫存調整 |
| 庫存查詢 | 即時庫存顯示、安全庫存預警 |
| 交易日誌 | 完整操作軌跡、當日交易取消功能 |
| LINE Bot | 群組出庫、商品查詢、即時庫存查詢 |
| Google Sheets | 每日報表自動生成、異動單追溯更新 |

---

## 系統鐵律

本系統遵循以下不可違反的業務規則：

1. **一店一 Bot**：每個分店對應一個 LINE 群組，透過群組 ID 綁定分店。

2. **業務日區間**：業務日定義為 05:00:00 至隔日 04:59:59。所有系統（LINE Bot、Web App、Google Sheets、資料庫）統一使用此定義。

3. **箱/散絕對不轉換**：箱數與散數獨立管理，除非透過異動單明確執行「箱散轉換」，否則系統不會自動轉換。

4. **箱數對箱數、散數對散數**：出庫時，箱庫存只能出箱，散庫存只能出散。例如：庫存為 2 箱 5 散時，若要出庫 9 散，將會失敗（不會自動拆箱補散）。

5. **庫存不超賣**：禁止出現負數庫存，所有出庫操作都會先驗證庫存是否足夠。

---

## 技術架構

### 前端技術
- **React 19**：現代化前端框架
- **TypeScript**：型別安全的開發體驗
- **Tailwind CSS 4**：高效的樣式開發
- **shadcn/ui**：精美的 UI 元件庫

### 後端技術
- **Express.js**：Node.js Web 框架
- **tRPC**：端對端型別安全的 API
- **Drizzle ORM**：現代化的資料庫 ORM

### 資料庫
- **MySQL/TiDB**：關聯式資料庫
- **Supabase 相容**：可無縫遷移至 Supabase

### 外部整合
- **LINE Messaging API**：LINE Bot 功能
- **Google Sheets API v4**：報表自動化

---

## 資料庫結構

### 核心資料表

| 資料表 | 說明 |
|--------|------|
| `users` | 使用者資料，包含角色（總管/店長/一般使用者） |
| `stores` | 分店資料，包含 LINE 群組 ID 綁定 |
| `products` | 商品主檔，SKU 唯一識別 |
| `inventory` | 庫存資料，箱/散分開記錄 |
| `transactions` | 交易記錄，完整操作軌跡 |
| `adjustments` | 異動單，支援審核工作流 |
| `adjustment_items` | 異動單明細 |
| `daily_snapshots` | 每日庫存快照，用於報表生成 |
| `stock_takes` | 盤點記錄 |
| `stock_take_items` | 盤點明細 |
| `audit_logs` | 審計日誌 |

---

## 使用者角色與權限

| 角色 | 權限說明 |
|------|----------|
| 總管 (admin) | 可查看所有分店、審核異動單、管理使用者、管理商品 |
| 店長 (store_manager) | 僅能操作所屬分店、申請異動單、執行入庫/出庫/盤點 |
| 一般使用者 (user) | 僅能查看資料，無法執行操作 |

---

## LINE Bot 指令說明

### 查詢商品

| 指令格式 | 說明 | 範例 |
|----------|------|------|
| `查 關鍵字` | 以商品名稱搜尋 | `查可樂`、`查 可樂`、`查詢 可樂` |
| `條碼 XXX` | 以條碼精確搜尋 | `條碼 4710088123456`、`條碼：123` |
| `編號 XXX` | 以 SKU 精確搜尋 | `編號 BC191`、`#BC191` |

### 出庫指令

查詢商品後，可直接輸入出庫指令：

| 指令格式 | 說明 |
|----------|------|
| `出3箱` | 出庫 3 箱 |
| `出5散` 或 `出5` | 出庫 5 散（純數字視為散數） |
| `出3箱2散` | 出庫 3 箱 2 散 |
| `出3箱1` | 出庫 3 箱 1 散（最後數字視為散數） |

### 入庫指令

| 指令格式 | 說明 |
|----------|------|
| `入3箱` | 入庫 3 箱 |
| `入5散` 或 `入5` | 入庫 5 散 |
| `入3箱2散` | 入庫 3 箱 2 散 |

### 操作流程範例

```
使用者：查胖胖
Bot：找到以下與「胖胖」相關的選項
     編號：BC191
     名稱：海底撈胖胖酥-麻辣風味55g

使用者：編號 BC191
Bot：名稱：海底撈胖胖酥-麻辣風味55g
     編號：BC191
     箱入數：15
     單價：31
     倉庫類別：總倉
     庫存：16箱0散

使用者：出3箱
Bot：✅ 出庫成功
     品名：海底撈胖胖酥-麻辣風味55g
     編號：BC191
     倉別：總倉
     出庫：3箱 0件
     👉目前庫存：13箱0散
```

---

## Web App 功能說明

### 主頁
- 顯示使用者資訊與角色
- 快速導航至各功能模組
- 庫存預警提醒

### 商品管理
- 新增/編輯/刪除商品
- 設定 SKU、名稱、條碼、箱入數、單價
- 設定安全庫存（箱/散分開）

### 分店管理
- 新增/編輯/刪除分店
- 設定分店代碼、名稱、地址、電話
- 綁定 LINE 群組 ID

### 入庫作業
- 選擇分店與商品
- 輸入入庫數量（箱/散分開）
- 輸入單位成本（系統自動計算加權平均成本）

### 異動單
- 建立補出庫/補入庫/箱散轉換申請
- 選擇異動日期（可回溯歷史日期）
- 審核工作流（總管審核）
- 審核通過後自動追溯更新受影響日期的報表

### 月盤點
- 選擇分店與盤點月份
- 輸入實際盤點數量
- 系統自動計算差異
- 完成盤點後自動調整庫存

### 庫存查詢
- 查看各分店各商品的即時庫存
- 安全庫存預警顯示
- 支援篩選與搜尋

### 交易記錄
- 查看所有交易歷史
- 支援日期範圍篩選
- 當日交易可取消（需無後續交易）

### 使用者管理
- 查看所有使用者
- 設定使用者角色
- 綁定使用者至分店

---

## Google Sheets 報表

### 工作表命名規則
- 以 MMdd 格式命名（如 `0127` 代表 1 月 27 日）
- 當日工作表即時更新
- 歷史工作表自動凍結

### 報表欄位

| 欄位 | 說明 |
|------|------|
| SKU | 商品編號 |
| 商品名稱 | 商品名稱 |
| 分店 | 分店名稱 |
| 期初箱數/散數/成本 | 當日開始時的庫存 |
| 入庫箱數/散數/成本 | 當日入庫總計 |
| 出庫箱數/散數/成本 | 當日出庫總計 |
| 調整箱數/散數/成本 | 盤點調整/異動單調整 |
| 期末箱數/散數/成本 | 當日結束時的庫存 |
| 平均成本(箱/散) | 加權平均成本 |

### 異動單追溯更新
當異動單審核通過後，系統會自動更新從異動日期到今天的所有報表。例如：今天是 1/27，審核通過一筆 1/24 的補出庫，系統會自動更新 0124、0125、0126、0127 四個工作表。

---

## 環境變數設定

### LINE Bot 設定
```
LINE_CHANNEL_ACCESS_TOKEN=你的 LINE Channel Access Token
LINE_CHANNEL_SECRET=你的 LINE Channel Secret
```

### Google Sheets 設定
```
GOOGLE_SHEETS_SPREADSHEET_ID=你的 Google Sheets ID
GOOGLE_SERVICE_ACCOUNT_EMAIL=你的服務帳戶 Email
GOOGLE_SERVICE_ACCOUNT_PRIVATE_KEY=你的服務帳戶私鑰
```

---

## 部署說明

### 開發環境
```bash
# 安裝依賴
pnpm install

# 執行資料庫遷移
pnpm db:push

# 啟動開發伺服器
pnpm dev
```

### 生產環境
```bash
# 建置
pnpm build

# 啟動
pnpm start
```

### LINE Bot Webhook 設定
將 Webhook URL 設定為：`https://你的網域/api/linebot/webhook`

---

## 常見問題

### Q: 為什麼出庫失敗顯示「散庫存不足」？
A: 系統遵循「箱數對箱數、散數對散數」的鐵律。即使箱庫存足夠，也不會自動拆箱補散。如需轉換，請使用異動單的「箱散轉換」功能。

### Q: 如何補帳歷史日期的出入庫？
A: 使用異動單功能，選擇「補出庫」或「補入庫」，並指定正確的異動日期。審核通過後，系統會自動追溯更新受影響日期的報表。

### Q: 交易記錄可以取消嗎？
A: 僅限當日交易，且該商品在該筆交易之後沒有其他交易時，才能取消。

### Q: Google Sheets 報表沒有更新？
A: 請確認環境變數已正確設定，並檢查服務帳戶是否有該試算表的編輯權限。

---

## 技術支援

如有任何問題，請聯繫系統管理員或提交 Issue。
